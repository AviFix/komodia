<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head profile="http://purl.org/uF/hAtom/0.1/ http://purl.org/uF/2008/03/">
	
	<title>WFP (Windows Filtering Platform) practical guide</title>

	<!-- Meta Tags -->
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="generator" content="WordPress" />
	<meta name="framework" content="WP Framework" />

	<!-- Favicon: Browser + iPhone Webclip -->
	<link rel="shortcut icon" href="wp-content/themes/wp-framework/images/favicon.jpg" />

	<!-- Stylesheets -->
	<link rel="stylesheet" href="wp-content/themes/wp-framework/style.css" type="text/css" media="screen, projection" />
	<link rel="stylesheet" href="wp-content/themes/wp-framework/library/media/css/print.css" type="text/css" media="print" />

  	<!-- Links: RSS + Atom Syndication + Pingback etc. -->
	<link rel="alternate" type="application/rss+xml" title="Komodia RSS Feed" href="feed/rss" />
	<link rel="alternate" type="text/xml" title="RSS .92" href="feed/rss" />
	<link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="feed/atom" />
	<link rel="pingback" href="xmlrpc.php" />

	<!-- Theme Hook -->
    	<link rel="alternate" type="application/rss+xml" title="Komodia &raquo; WFP practical guide Comments Feed" href="wfp-practical-guide/feed" />
<link rel='stylesheet' id='really_simple_share_style-css'  href='wp-content/plugins/really-simple-facebook-twitter-share-buttons/style.css' type='text/css' media='all' />
<!-- This site uses the Yoast Google Analytics plugin v5.2.7 - Universal disabled - https://yoast.com/wordpress/plugins/google-analytics/ -->
<script type="text/javascript">

	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-34315916-1']);
	_gaq.push(['_gat._forceSSL']);
	_gaq.push(['_trackPageview']);

	(function () {
		var ga = document.createElement('script');
		ga.type = 'text/javascript';
		ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0];
		s.parentNode.insertBefore(ga, s);
	})();

</script>
<!-- / Yoast Google Analytics -->
<script type='text/javascript' src='wp-includes/js/jquery/jquery.js'></script>
<script type='text/javascript' src='wp-includes/js/jquery/jquery-migrate.min.js'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="xmlrpc.php@rsd" />
<link rel='shortlink' href='index.html@p=648.html' />

<!-- All in One SEO Pack 2.2.3.1 by Michael Torbert of Semper Fi Web Design[245,308] -->
<meta name="description"  content="Retail Products WFP practical guide Make sure to read the WFP high level overview guide before reading this guide. Why is WFP so" />

<link rel="canonical" href="index.html@p=648.html" />
<!-- /all in one seo pack -->
	<script type="text/javascript">
		function showSub(idname){
			document.getElementById(idname).style.display = "block";
		}
		function hideSub(idname){
			document.getElementById(idname).style.display = "none";
		}
	</script>
<!--END head-->
</head>
<body >
<div class="container top-space">
	<div id="header">
    	<div id="logo-holder"><a href="index.php.html"><img src="wp-content/themes/wp-framework/images/logo.gif" alt="Komodia Logo" border="0" /></a></div>
        <div id="menu-holder">
        	<div class="menu-left">&nbsp;</div>
        	<div class="menu-body">
        	<ul>
            	<li onmouseover="showSub('products')" onmouseout="hideSub('products')">
                	<a href="index.php@page=products.html">Products</a>
                    <div id="products" class="submenu">                    
                     <ul>
                    	<li><a href="index.php@page=redirector.html">Komodia's Redirector</a></li>
                        
                        <li><a href="index.php@page=ssl.html">Komodia's SSL Digestor</a></li>
                        <li><a href="index.php@page=rlsp.html">Komodia's Advanced LSP Installer</a></li>
                        <li><a href="products/komodias-watchdog/index.html">Komodia's Watchdog</a></li>
			<li><a href="products/ios/index.html">Komodia's iOS SDK</a></li>
			<li><a href="http://url.komodia.com">Komodia's classification service</a></li>
			<li><a href=http://www.komodia.com/client-side-per-page-classification-sdk">Client side classification SDK</a></li>
			<li><a href="parental-control-demo/index.html">Parental control demo</a></li>
			<li><a href="ad-injection-sdk/index.html">Ad injection SDK</a></li>
                    </ul>
                    <div class="clearer"></div>
                    </div>
				</li>
                <li onmouseover="showSub('lsp')" onmouseout="hideSub('lsp')">
                	<a href="index.php@page=lsp.html">LSP</a>
                    <div id="lsp" class="submenu">
                    	<ul>
                            <li><a href="index.php@page=lsp.html">LSP Guide</a></li>
                            <li><a href="index.php@page=lspsamp.html">LSP Sample</a></li>
			    <li><a href="challenges/index.html">LSP development challenges</a></li>
			    <li><a href="index.php@page=ndis.html">NDIS Guide</a></li>
			    <li><a href="index.php@page=wfp.html">WFP Guide</a></li>
			    <li><a href="index.php@page=tdi.html">TDI Guide</a></li>
			    <li><a href="dll-injection/index.html">DLL injection</a></li>

						</ul>                            
                    </div>
                </li>
                <li onmouseover="showSub('about')" onmouseout="hideSub('about')">
                	<a href="index.html@p=2.html">About Us</a>
                    <div id="about" class="submenu">
                    	<ul>
                        	<li><a href="index.html@p=2.html">Company Information</a></li>
                            <li><a href="index.html@p=155.html">Portfolio</a></li>
                            <li><a href="index.html@p=170.html">Services</a></li>
                        </ul>
                    </div>
				</li>
                <li><a href="index.php@page=newcontact.html" style="background:none;">Contact Us</a></li>
            </ul>
            </div>
            <div class="menu-right">&nbsp;</div>
            <div class="clearer"></div>
        </div>
        <div id="scanned-by"></div>
        <div class="clearer"></div>
	</div>
    <div class="center breadcrumb">
    	<span>&raquo;<a href="index.php.html">Komodia</a> Â» WFP practical guide</span>
    </div>		<script type="text/javascript">
</script>
    <div id="main">
    	<div id='fb-root'></div>
					<script type='text/javascript'>
						window.fbAsyncInit = function()
						{
							FB.init({appId: null, status: true, cookie: true, xfbml: true});
						};
						(function()
						{
							var e = document.createElement('script'); e.async = true;
							e.src = document.location.protocol + '//connect.facebook.net/en_US/all.js';
							document.getElementById('fb-root').appendChild(e);
						}());
					</script>	
					        	<p><script type="text/javascript" src="wthvideo/wthvideo3.js"></script></p>
<h3>Retail Products</h3>
<div class="center banner">
<ul>
<li><a href="index.html@p=6.html" onclick="_gaq.push(['_trackEvent', 'outbound-article-int', 'http://www.komodia.com/products/komodia-redirector', ' ']);" > </a></li>
<li><a href="index.php@page=ssl.html" onclick="_gaq.push(['_trackEvent', 'outbound-article-int', 'http://www.komodia.com/products/komodias-ssl-decoderdigestor/', ' ']);" > </a></li>
</ul>
</div>
<h3>WFP practical guide</h3>
<p>Make sure to read the <a href="index.html@p=244.html" onclick="_gaq.push(['_trackEvent', 'outbound-article-int', 'http://www.komodia.com/wfp_hl', 'WFP high level overview']);" >WFP high level overview</a> guide before reading this guide.</p>
<h4>Why is WFP so complex?</h4>
<p>Main implementation of WFP is driver based and driver development has always been hard and with shortage of documentation, also (not an official statement by Microsoft), at the past you could take an inexperienced developer, take the LSP samples, compile it, and show something that &#8220;worked&#8221; for interception, but the real problems came in the field and the developer could not solve them, giving users bad experience and crashes. With WFP the same inexperienced developer would not get far, he would not be able to produce the &#8220;working&#8221; scenario even on VMWare, so Microsoft had increased the bar of requirements from developers in order to write a WFP.</p>
<h4>How do I get started?</h4>
<p>There are number of prerequisites before starting to develop WFP:</p>
<ul>
<li>Understand driver programming, there are number of good books and sites on the subject. When running at Ring0 things are different then running at Ring3 (user level programming).</li>
<li>Understand TCP/IP networking, at the Winsock level and preferably at the packet level.</li>
</ul>
<h4>Alternative</h4>
<p>If you find WFP complex, and you want to develop a solution that requires network redirection, you should consider purchasing our <a href="index.html@p=6.html" onclick="_gaq.push(['_trackEvent', 'outbound-article-int', 'http://www.komodia.com/products/komodia-redirector', 'Network Redirection SDK']);" >Network Redirection SDK</a>, it works using LSP for Windows XP/Vista/2003/7/2008 and WFP for Windows 8/2012 and will save you great amount of time, trial and error, and frustration.</p>
<h4>WFP Sample</h4>
<p>Microsoft provides a sample that encompasses all of WFP functionality, the sample is quite big and can be confusing, never the less, you can take code snippets from it, and save time, you can get the sample <a href="http://code.msdn.microsoft.com/Windows-Filtering-Platform-27553baa" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'http://code.msdn.microsoft.com/Windows-Filtering-Platform-27553baa', 'here']);"  target="_blank" rel="nofollow">here</a>.</p>
<h4>Callout selection</h4>
<p>First step would be to select the right <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff556954%28v=vs.85%29.aspx" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'http://msdn.microsoft.com/en-us/library/windows/hardware/ff556954%28v=vs.85%29.aspx', 'callout']);"  target="_blank" rel="nofollow">callout</a>, a callout will get us the traffic to inspect/modify and the callout will depend on what we plan to do, for transparent proxy redirection we will use the callout: <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff571005%28v=vs.85%29.aspx" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'http://msdn.microsoft.com/en-us/library/windows/hardware/ff571005%28v=vs.85%29.aspx', 'FWPM_LAYER_ALE_CONNECT_REDIRECT_V4']);"  target="_blank" rel="nofollow">FWPM_LAYER_ALE_CONNECT_REDIRECT_V4</a> this callout will let us change every outgoing TCPv4 connection and redirect it to a proxy (local or remote). There are other type of callouts that will allow you to intercept: Packets, streams, discraded packets, incoming connections, but they will not be covered in this short guide.</p>
<h4>Callout registration</h4>
<p>A callout is registered via the method <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff551140%28v=vs.85%29.aspx" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'http://msdn.microsoft.com/en-us/library/windows/hardware/ff551140%28v=vs.85%29.aspx', 'FwpsCalloutRegister0']);"  target="_blank" rel="nofollow">FwpsCalloutRegister0</a> (for Windows Vista/7/2008) or <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff551143%28v=vs.85%29.aspx" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'http://msdn.microsoft.com/en-us/library/windows/hardware/ff551143%28v=vs.85%29.aspx', 'FwpsCalloutRegister1']);"  target="_blank" rel="nofollow">FwpsCalloutRegister1</a> (for Windows 8/2012) it expects the current driver device, the callout structure: <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff551224%28v=vs.85%29.aspx" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'http://msdn.microsoft.com/en-us/library/windows/hardware/ff551224%28v=vs.85%29.aspx', 'FWPS_CALLOUT0']);"  target="_blank" rel="nofollow">FWPS_CALLOUT0</a> or <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff551226%28v=vs.85%29.aspx" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'http://msdn.microsoft.com/en-us/library/windows/hardware/ff551226%28v=vs.85%29.aspx', 'FWPS_CALLOUT1']);"  target="_blank" rel="nofollow">FWPS_CALLOUT1</a> (both contain the classification and notification functions) and the ID of the callout (the one we selected the paragraph before).</p>
<h4>Acquiring the filtering engine handle</h4>
<p>The handle is required for many WFP operations and you can get it using the function <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa364040%28v=vs.85%29.aspx" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'http://msdn.microsoft.com/en-us/library/windows/desktop/aa364040%28v=vs.85%29.aspx', 'FwpmEngineOpen0']);"  target="_blank" rel="nofollow">FwpmEngineOpen0</a>.</p>
<h4>Adding the callout</h4>
<p>Once we registered our driver with the specific callout, we need to add it to the filtering engine using the method <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa364010%28v=vs.85%29.aspx" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'http://msdn.microsoft.com/en-us/library/windows/desktop/aa364010%28v=vs.85%29.aspx', 'FwpmCalloutAdd0']);"  target="_blank" rel="nofollow">FwpmCalloutAdd0</a>, it expects the handle to the filtering engine, <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa364250%28v=vs.85%29.aspx" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'http://msdn.microsoft.com/en-us/library/windows/desktop/aa364250%28v=vs.85%29.aspx', 'FWPM_CALLOUT0 structure']);"  target="_blank" rel="nofollow">FWPM_CALLOUT0 structure</a>, security descriptor (optional), and an unique ID (optional).</p>
<h4>Adding the filter</h4>
<p>Last but not least we need to add the filter which describes on top of the callout type, which traffic we want to intercept (Protocol, flags, etc), we do that using the method: <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa364046%28v=vs.85%29.aspx" onclick="_gaq.push(['_trackEvent', 'outbound-article', 'http://msdn.microsoft.com/en-us/library/windows/desktop/aa364046%28v=vs.85%29.aspx', 'FwpmFilterAdd0']);"  target="_blank" rel="nofollow">FwpmFilterAdd0</a>, which expects the handle to the filtering engine, FWPM_FILTER0 structure, security descriptor (optional), and an unique ID (optional).</p>
<div class='wpfblike' style='height: 40px;'><fb:like href='http://www.komodia.com/wfp-practical-guide' layout='standard' show_faces='true' width='400' action='like' colorscheme='light' send='false' /></div>            </div>
</div>
<script type="text/javascript">
        //<![CDATA[
        
      !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
      
      window.___gcfg = {lang: "en"};
		  (function() {
		    var po = document.createElement("script"); po.type = "text/javascript"; po.async = true;
		    po.src = "https://apis.google.com/js/plusone.js";
		    var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(po, s);
		  })();
      
        //]]>
  		</script>
  <div id="fb-root"></div>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.0";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));</script><!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u=(("https:" == document.location.protocol) ? "https" : "http") + "://piwik.komodia.com/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 1]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0]; g.type='text/javascript';
    g.defer=true; g.async=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Piwik Code -->
<script type='text/javascript' src='https://platform.linkedin.com/in.js'></script>
<script type='text/javascript' src='wp-includes/js/hoverIntent.min.js'></script>
<script type='text/javascript' src='wp-includes/js/comment-reply.min.js'></script>
<div id="footer" class="container">
	<p>Copyright &copy; 2000-2013 Komodia Inc. All rights reserved.</p>
    <div id="footer-menu">
    	<ul>
        	<li><a href="index.php@page=about.html">About Us</a></li>
		 <li><a href="index.html@p=673.html">Press releases</a></li>
		<li><a href="index.html@p=743.html">Newsletters</a></li>
            <li><a href="index.html@p=701.html">Blogs</a></li>
            <li><a href="wiki/index.php@title=Main_Page.html" target="_blank">Wiki</a></li>
            <li><a href="videos/index.html">Videos</a></li>
		<li><a href="wiki/index.php@title=Komodia%2527s_site_legal_information.html" target="_blank">Privacy</a></li>

            <li><a id="fb" href="http://www.facebook.com/komodia#!/pages/Komodia/129677207087283" target="_blank">Visit Us on Facebook</a></li>
        </ul>
    </div>
    <div class="clearer"></div>
</div>
</body>
</html>
<!-- Performance optimized by W3 Total Cache. Learn more: http://www.w3-edge.com/wordpress-plugins/

Page Caching using disk: enhanced
Database Caching 1/6 queries in 0.002 seconds using disk
Object Caching 499/509 objects using disk

 Served from: www.komodia.com @ 2014-12-19 20:04:11 by W3 Total Cache -->