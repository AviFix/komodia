<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<title>DNS hijack - Komodia</title>
<meta charset="UTF-8" />
<meta name="generator" content="MediaWiki 1.20.4" />
<meta name="robots" content="noindex,nofollow" />
<link rel="shortcut icon" href="../favicon.ico" />
<link rel="search" type="application/opensearchdescription+xml" href="opensearch_desc.php" title="Komodia (en)" />
<link rel="EditURI" type="application/rsd+xml" href="api.php@action=rsd" />
<link rel="alternate" type="application/atom+xml" title="Komodia Atom feed" href="index.php@title=Special%253ARecentChanges&amp;feed=atom" />
<link rel="stylesheet" href="load.php@debug=false&amp;lang=en&amp;modules=mediawiki.legacy.commonPrint%252Cshared%257Cskins.monobook&amp;only=styles&amp;skin=monobook&amp;%252A.css" />
<!--[if IE 6]><link rel="stylesheet" href="/wiki/skins/monobook/IE60Fixes.css?303" media="screen" /><![endif]-->
<!--[if IE 7]><link rel="stylesheet" href="/wiki/skins/monobook/IE70Fixes.css?303" media="screen" /><![endif]--><meta name="ResourceLoaderDynamicStyles" content="" />
<style>a:lang(ar),a:lang(ckb),a:lang(fa),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}
/* cache key: komod_wikidb:resourceloader:filter:minify-css:7:dffa96a73b1be9b0dae7e17005fcc939 */</style>

<script src="load.php@debug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=monobook&amp;%252A"></script>
<script>if(window.mw){
mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"DNS_hijack","wgTitle":"DNS hijack","wgCurRevisionId":826,"wgArticleId":64,"wgIsArticle":true,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":[],"wgBreakFrames":false,"wgPageContentLanguage":"en","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"DNS_hijack","wgRestrictionEdit":[],"wgRestrictionMove":[]});
}</script><script>if(window.mw){
mw.loader.implement("user.options",function(){mw.user.options.set({"ccmeonemails":0,"cols":80,"date":"default","diffonly":0,"disablemail":0,"disablesuggest":0,"editfont":"default","editondblclick":0,"editsection":1,"editsectiononrightclick":0,"enotifminoredits":0,"enotifrevealaddr":0,"enotifusertalkpages":1,"enotifwatchlistpages":0,"extendwatchlist":0,"externaldiff":0,"externaleditor":0,"fancysig":0,"forceeditsummary":0,"gender":"unknown","hideminor":0,"hidepatrolled":0,"imagesize":2,"justify":0,"math":1,"minordefault":0,"newpageshidepatrolled":0,"nocache":0,"noconvertlink":0,"norollbackdiff":0,"numberheadings":0,"previewonfirst":0,"previewontop":1,"quickbar":5,"rcdays":7,"rclimit":50,"rememberpassword":0,"rows":25,"searchlimit":20,"showhiddencats":0,"showjumplinks":1,"shownumberswatching":1,"showtoc":1,"showtoolbar":1,"skin":"monobook","stubthreshold":0,"thumbsize":2,"underline":2,"uselivepreview":0,"usenewrc":0,"watchcreations":0,"watchdefault":0,"watchdeletion":0,"watchlistdays":3,
"watchlisthideanons":0,"watchlisthidebots":0,"watchlisthideliu":0,"watchlisthideminor":0,"watchlisthideown":0,"watchlisthidepatrolled":0,"watchmoves":0,"wllimit":250,"variant":"en","language":"en","searchNs0":true,"searchNs1":false,"searchNs2":false,"searchNs3":false,"searchNs4":false,"searchNs5":false,"searchNs6":false,"searchNs7":false,"searchNs8":false,"searchNs9":false,"searchNs10":false,"searchNs11":false,"searchNs12":false,"searchNs13":false,"searchNs14":false,"searchNs15":false});;},{},{});mw.loader.implement("user.tokens",function(){mw.user.tokens.set({"editToken":"+\\","watchToken":false});;},{},{});
/* cache key: komod_wikidb:resourceloader:filter:minify-js:7:c89fc005766e312c555f83b307d08d63 */
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.page.startup","mediawiki.legacy.wikibits","mediawiki.legacy.ajax"]);
}</script>
</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-DNS_hijack skin-monobook action-view">
<div id="globalWrapper">
<div id="column-content"><div id="content" class="mw-body-primary">
	<a id="top"></a>
	
	<h1 id="firstHeading" class="firstHeading"><span dir="auto">DNS hijack</span></h1>
	<div id="bodyContent" class="mw-body">
		<div id="siteSub">From Komodia</div>
		<div id="contentSub"><div id="mw-revision-info">Revision as of 12:39, 30 January 2012 by <a href="http://www.komodia.com/wiki/index.php?title=User:Barak&amp;action=edit&amp;redlink=1" class="new mw-userlink" title="User:Barak (page does not exist)">Barak</a>  <span class="mw-usertoollinks">(<a href="http://www.komodia.com/wiki/index.php?title=User_talk:Barak&amp;action=edit&amp;redlink=1" class="new" title="User talk:Barak (page does not exist)">Talk</a> | <a href="index.php/Special%253AContributions/Barak.html" title="Special:Contributions/Barak">contribs</a>)</span></div><br />
				<div id="mw-revision-nav">(<a href="http://www.komodia.com/wiki/index.php?title=DNS_hijack&amp;diff=prev&amp;oldid=826" title="DNS hijack">diff</a>) <a href="http://www.komodia.com/wiki/index.php?title=DNS_hijack&amp;direction=prev&amp;oldid=826" title="DNS hijack">← Older revision</a> | Latest revision (diff) | Newer revision → (diff)</div></div>
		<div id="jump-to-nav" class="mw-jump">Jump to: <a href="index.php@title=DNS_hijack&amp;oldid=826.html#column-one">navigation</a>, <a href="index.php@title=DNS_hijack&amp;oldid=826.html#searchInput">search</a></div>
		<!-- start content -->
<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr"><table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="index.php@title=DNS_hijack&amp;oldid=826.html#What_is_the_DNS_hijack_module"><span class="tocnumber">1</span> <span class="toctext">What is the DNS hijack module</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="index.php@title=DNS_hijack&amp;oldid=826.html#LSP.2FWFP"><span class="tocnumber">2</span> <span class="toctext">LSP/WFP</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="index.php@title=DNS_hijack&amp;oldid=826.html#When_is_it_used"><span class="tocnumber">3</span> <span class="toctext">When is it used</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="index.php@title=DNS_hijack&amp;oldid=826.html#How_does_it_work"><span class="tocnumber">4</span> <span class="toctext">How does it work</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="index.php@title=DNS_hijack&amp;oldid=826.html#What_it_is_not"><span class="tocnumber">5</span> <span class="toctext">What it is not</span></a></li>
<li class="toclevel-1 tocsection-6"><a href="index.php@title=DNS_hijack&amp;oldid=826.html#Limitations"><span class="tocnumber">6</span> <span class="toctext">Limitations</span></a></li>
<li class="toclevel-1 tocsection-7"><a href="index.php@title=DNS_hijack&amp;oldid=826.html#Alternatives"><span class="tocnumber">7</span> <span class="toctext">Alternatives</span></a></li>
<li class="toclevel-1 tocsection-8"><a href="index.php@title=DNS_hijack&amp;oldid=826.html#How_to_modify_the_code"><span class="tocnumber">8</span> <span class="toctext">How to modify the code</span></a>
<ul>
<li class="toclevel-2 tocsection-9"><a href="index.php@title=DNS_hijack&amp;oldid=826.html#Decide_if_to_DNS_intercept_the_app"><span class="tocnumber">8.1</span> <span class="toctext">Decide if to DNS intercept the app</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="index.php@title=DNS_hijack&amp;oldid=826.html#Modify_the_DNS_functions"><span class="tocnumber">8.2</span> <span class="toctext">Modify the DNS functions</span></a></li>
<li class="toclevel-2 tocsection-11"><a href="index.php@title=DNS_hijack&amp;oldid=826.html#Forcing_an_application_to_redirect_certain_connections"><span class="tocnumber">8.3</span> <span class="toctext">Forcing an application to redirect certain connections</span></a></li>
</ul>
</li>
</ul>
</td></tr></table>
<h1> <span class="mw-headline" id="What_is_the_DNS_hijack_module"> What is the DNS hijack module </span></h1>
<p>The DNS hijack is a module that is layered on top of <a href="index.php/Komodia's_Redirector.html" title="Komodia's Redirector">Komodia's Redirector</a> and allows the programmer to defer the DNS query to another DNS server or up stream proxy.
</p>
<h1> <span class="mw-headline" id="LSP.2FWFP"> LSP/WFP </span></h1>
<p>Currently the module is working with the LSP only.
</p>
<h1> <span class="mw-headline" id="When_is_it_used"> When is it used </span></h1>
<p>There are numbers of scenarios is will be used:
</p>
<ul><li> Deferring the query to an upstream server in case of anonymizers or bypassing ISP DNS blocks.
</li><li> It's another way to get the host of a HTTPS request without using the <a href="index.php/SSL_Digestor.html" title="SSL Digestor">SSL Digestor</a>.
</li><li> Allowing for custom DNS query to be performed.
</li></ul>
<h1> <span class="mw-headline" id="How_does_it_work"> How does it work </span></h1>
<p>The module works by hooking into the DNS methods when the LSP loads, and when the app calls the methods, it replaces them with fake IPs, later in the process the Redirector knows to replace the fake IP with the host name queried and gives the programmer a choice to resolve the DNS him self, send it to up stream proxy, or just resolve it normally.
</p>
<h1> <span class="mw-headline" id="What_it_is_not"> What it is not </span></h1>
<p>The module does not give you access to the UDP packets of the query, in fact, the query is not made at all because it is being intercepted, at the Redirector level you are able to perform a custom query, but it's with code you need to implement. If the Redirector is resolving that query it uses normal Windows API to do so.
</p>
<h1> <span class="mw-headline" id="Limitations"> Limitations </span></h1>
<p>There are two limitations that should be noted:
</p>
<ul><li> The module does not intercept the central DNS service, it works on a per app basis and the traffic of the app must be intercepted as well.
</li><li> There are situations where some apps are using the DNS methods before loading Winsock, which means that all DNS queries before the initializations of Winsock will not go directly, this does not occurs with the leading browsers, and when it does occur, usually it's for one request only.
</li><li> Sometimes there are need for a custom DNS query, in that case the programmer must have the ability to perform that custom query because the module does not give access to UDP packets.
</li></ul>
<h1> <span class="mw-headline" id="Alternatives"> Alternatives </span></h1>
<p>You can implement a central DNS interception using: TDI/NDIS/WFP, usually this is done only if you want to modify the outgoing UDP packets.
</p>
<h1> <span class="mw-headline" id="How_to_modify_the_code"> How to modify the code </span></h1>
<p>This is a short guide to explain how you can modify the code to develop extra features that are not supported in box
</p>
<h2> <span class="mw-headline" id="Decide_if_to_DNS_intercept_the_app"> Decide if to DNS intercept the app </span></h2>
<p>The check whether to intercept the DNS in the app is performed at: spi.cpp&#160;: InterceptDNS, you need to modify this function is you want to separate the interception of the DNS from the redirection rules.
</p>
<h2> <span class="mw-headline" id="Modify_the_DNS_functions"> Modify the DNS functions </span></h2>
<p>The component "detours" the WinAPI DNS functions, and you can modify those functions to selectively intercept or bypass the domains being queried, this check is performed at: DNSInterceptor.cpp&#160;: Mine_gethostbyname, Mine_GetAddrInfo, Mine_GetAddrInfoW
</p><p>Inside each function there's an initial check at start to determine is the interception should be made, there's a boolean called bSkip, if you set it to true, the DNS query will go out directly (DNS bypass)
</p>
<h2> <span class="mw-headline" id="Forcing_an_application_to_redirect_certain_connections"> Forcing an application to redirect certain connections </span></h2>
<p>You can force the application to redirect even if it wasn't set in the rules, you do that inside: spi.cpp&#160;: WSPConnect
</p><p>First step is the conversion between the fake address to the host name which is done at this line:
</p>
<pre>

#if defined DNS_HIJACK &amp;&amp; defined DNS_BUILD &amp;&amp; defined DNS_ANON
	//Should we do it?
	if (gGlobalDNSInit)

</pre>
<p>Then the second check is done with the rule base at:
</p>
<pre>

//Do we need to hijack?
	if (bHijack &amp;&amp;
		!gIgnore &amp;&amp;
#ifndef INTERCEPT_LOCALHOST
		(pAdr-&gt;sin_addr.S_un.S_un_b.s_b1!=127 || bDNS) &amp;&amp;
#endif
		!gAvoid)
	{

</pre>
<p>You'll need to modify some of the COM calls with rules of your own, evetually this is the start of the code part that performs the redirect:
</p>
<pre>
					//Yes it's our port, we need to hijack
					//First set the original
					SocketContext-&gt;aOriginalAddress=*pAdr;
</pre>

<!-- 
NewPP limit report
Preprocessor visited node count: 67/1000000
Preprocessor generated node count: 0/1000000
Post‐expand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
Highest expansion depth: 2/40
Expensive parser function count: 0/100
-->

<!-- Saved in parser cache with key komod_wikidb:pcache:idhash:64-0!*!0!!en!*!* and timestamp 20150219152328 -->
</div><div class="printfooter">
Retrieved from "<a href="index.php@title=DNS_hijack&amp;oldid=826.html">http://www.komodia.com/wiki/index.php?title=DNS_hijack&amp;oldid=826</a>"</div>
		<div id='catlinks' class='catlinks catlinks-allhidden'></div>		<!-- end content -->
				<div class="visualClear"></div>
	</div>
</div></div>
<div id="column-one">
	<div id="p-cactions" class="portlet">
		<h5>Views</h5>
		<div class="pBody">
			<ul>
				<li id="ca-nstab-main" class="selected"><a href="index.php/DNS_hijack.html" primary="1" context="subject" title="View the content page [c]" accesskey="c">Page</a></li>
				<li id="ca-talk" class="new"><a href="http://www.komodia.com/wiki/index.php?title=Talk:DNS_hijack&amp;action=edit&amp;redlink=1" primary="1" context="talk" title="Discussion about the content page [t]" accesskey="t">Discussion</a></li>
				<li id="ca-viewsource"><a href="index.php@title=DNS_hijack&amp;action=edit.html" primary="1" title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></li>
				<li id="ca-history"><a href="index.php@title=DNS_hijack&amp;action=history.html" rel="archives" title="Past revisions of this page [h]" accesskey="h">History</a></li>
			</ul>
		</div>
	</div>
	<div class="portlet" id="p-personal">
		<h5>Personal tools</h5>
		<div class="pBody">
			<ul>
				<li id="pt-anonuserpage"><a href="http://www.komodia.com/wiki/index.php/User:46.165.222.245" class="new" title="The user page for the IP address you are editing as [.]" accesskey=".">46.165.222.245</a></li>
				<li id="pt-anontalk"><a href="http://www.komodia.com/wiki/index.php/User_talk:46.165.222.245" class="new" title="Discussion about edits from this IP address [n]" accesskey="n">Talk for this IP address</a></li>
				<li id="pt-anonlogin"><a href="http://www.komodia.com/wiki/index.php?title=Special:UserLogin&amp;returnto=DNS+hijack&amp;returntoquery=oldid%3D826" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li>
			</ul>
		</div>
	</div>
	<div class="portlet" id="p-logo">
<a href="index.php/Main_Page.html" style="background-image: url(http://www.komodia.com/images/logo.png);" title="Visit the main page"></a>
	</div>
	<div class="generated-sidebar portlet" id="p-navigation">
		<h5>Navigation</h5>
		<div class='pBody'>
			<ul>
				<li id="n-mainpage-description"><a href="index.php/Main_Page.html" title="Visit the main page [z]" accesskey="z">Main page</a></li>
				<li id="n-Official-homepage"><a href="../index.php.html">Official homepage</a></li>
				<li id="n-recentchanges"><a href="index.php/Special%253ARecentChanges.html" title="A list of recent changes in the wiki [r]" accesskey="r">Recent changes</a></li>
			</ul>
		</div>
	</div>
	<div id="p-search" class="portlet">
		<h5><label for="searchInput">Search</label></h5>
		<div id="searchBody" class="pBody">
			<form action="http://www.komodia.com/wiki/index.php" id="searchform">
				<input type='hidden' name="title" value="Special:Search"/>
				<input type="search" name="search" title="Search Komodia [f]" accesskey="f" id="searchInput" />
				<input type="submit" name="go" value="Go" title="Go to a page with this exact name if exists" id="searchGoButton" class="searchButton" />&#160;
				<input type="submit" name="fulltext" value="Search" title="Search the pages for this text" id="mw-searchButton" class="searchButton" />
			</form>
		</div>
	</div>
	<div class="portlet" id="p-tb">
		<h5>Toolbox</h5>
		<div class="pBody">
			<ul>
				<li id="t-whatlinkshere"><a href="index.php/Special%253AWhatLinksHere/DNS_hijack.html" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li>
				<li id="t-recentchangeslinked"><a href="index.php/Special%253ARecentChangesLinked/DNS_hijack.html" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li>
				<li id="t-specialpages"><a href="index.php/Special%253ASpecialPages.html" title="A list of all special pages [q]" accesskey="q">Special pages</a></li>
				<li id="t-print"><a href="http://www.komodia.com/wiki/index.php?title=DNS_hijack&amp;oldid=826&amp;printable=yes" rel="alternate" title="Printable version of this page [p]" accesskey="p">Printable version</a></li>
				<li id="t-permalink"><a href="index.php@title=DNS_hijack&amp;oldid=826.html" title="Permanent link to this revision of the page">Permanent link</a></li>
			</ul>
		</div>
	</div>
</div><!-- end of the left (by default at least) column -->
<div class="visualClear"></div>
<div id="footer">
	<div id="f-poweredbyico">
		<a href="http://www.mediawiki.org/"><img src="skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" width="88" height="31" /></a>
	</div>
	<ul id="f-list">
		<li id="lastmod"> This page was last modified on 30 January 2012, at 12:39.</li>
		<li id="viewcount">This page has been accessed 5,893 times.</li>
		<li id="privacy"><a href="index.php/Komodia%253APrivacy_policy.html" title="Komodia:Privacy policy">Privacy policy</a></li>
		<li id="about"><a href="index.php/Komodia%253AAbout.html" title="Komodia:About">About Komodia</a></li>
		<li id="disclaimer"><a href="index.php/Komodia%253AGeneral_disclaimer.html" title="Komodia:General disclaimer">Disclaimers</a></li>
	</ul>
</div>
</div>
<script>if(window.mw){
mw.loader.state({"site":"loading","user":"missing","user.groups":"ready"});
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.user","mediawiki.page.ready","mediawiki.searchSuggest"], null, true);
}</script>
<script>if(window.mw){
mw.loader.state({"site":"ready"});
}</script>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-6898822-1");
pageTracker._trackPageview();
</script><!-- Piwik -->
<script type="text/javascript">
/* <![CDATA[ */
var pkBaseURL = (("https:" == document.location.protocol) ? "https://piwik.komodia.com/" : "http://piwik.komodia.com/");
document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
/* ]]> */
</script>
<script type="text/javascript">
/* <![CDATA[ */
try {
var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 6);
piwikTracker.setDocumentTitle("");
piwikTracker.setIgnoreClasses("image");

piwikTracker.trackPageView();
piwikTracker.enableLinkTracking();
} catch( err ) {}
/* ]]> */
</script><noscript><p><img src="http://piwik.komodia.com/piwik.php?idsite=6" style="border:0" alt=""/></p></noscript>
<!-- /Piwik --><!-- Served in 0.175 secs. --></body></html>