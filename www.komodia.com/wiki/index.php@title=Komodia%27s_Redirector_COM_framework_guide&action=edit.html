<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<title>View source for Komodia's Redirector COM framework guide - Komodia</title>
<meta charset="UTF-8" />
<meta name="generator" content="MediaWiki 1.20.4" />
<link rel="next" href="index.php/Komodia's_Redirector_COM_framework_guide.html" />
<link rel="shortcut icon" href="../favicon.ico" />
<link rel="search" type="application/opensearchdescription+xml" href="opensearch_desc.php" title="Komodia (en)" />
<link rel="EditURI" type="application/rsd+xml" href="api.php@action=rsd" />
<link rel="alternate" type="application/atom+xml" title="Komodia Atom feed" href="index.php@title=Special%253ARecentChanges&amp;feed=atom" />
<link rel="stylesheet" href="load.php@debug=false&amp;lang=en&amp;modules=mediawiki.legacy.commonPrint%252Cshared%257Cskins.monobook&amp;only=styles&amp;skin=monobook&amp;%252A.css" />
<!--[if IE 6]><link rel="stylesheet" href="/wiki/skins/monobook/IE60Fixes.css?303" media="screen" /><![endif]-->
<!--[if IE 7]><link rel="stylesheet" href="/wiki/skins/monobook/IE70Fixes.css?303" media="screen" /><![endif]--><meta name="ResourceLoaderDynamicStyles" content="" />
<style>a:lang(ar),a:lang(ckb),a:lang(fa),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}
/* cache key: komod_wikidb:resourceloader:filter:minify-css:7:dffa96a73b1be9b0dae7e17005fcc939 */</style>

<script src="load.php@debug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=monobook&amp;%252A"></script>
<script>if(window.mw){
mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"Komodia\'s_Redirector_COM_framework_guide","wgTitle":"Komodia\'s Redirector COM framework guide","wgCurRevisionId":1333,"wgArticleId":54,"wgIsArticle":false,"wgAction":"edit","wgUserName":null,"wgUserGroups":["*"],"wgCategories":[],"wgBreakFrames":true,"wgPageContentLanguage":"en","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"Komodia\'s_Redirector_COM_framework_guide","wgRestrictionEdit":[],"wgRestrictionMove":[]});
}</script><script>if(window.mw){
mw.loader.implement("user.options",function(){mw.user.options.set({"ccmeonemails":0,"cols":80,"date":"default","diffonly":0,"disablemail":0,"disablesuggest":0,"editfont":"default","editondblclick":0,"editsection":1,"editsectiononrightclick":0,"enotifminoredits":0,"enotifrevealaddr":0,"enotifusertalkpages":1,"enotifwatchlistpages":0,"extendwatchlist":0,"externaldiff":0,"externaleditor":0,"fancysig":0,"forceeditsummary":0,"gender":"unknown","hideminor":0,"hidepatrolled":0,"imagesize":2,"justify":0,"math":1,"minordefault":0,"newpageshidepatrolled":0,"nocache":0,"noconvertlink":0,"norollbackdiff":0,"numberheadings":0,"previewonfirst":0,"previewontop":1,"quickbar":5,"rcdays":7,"rclimit":50,"rememberpassword":0,"rows":25,"searchlimit":20,"showhiddencats":0,"showjumplinks":1,"shownumberswatching":1,"showtoc":1,"showtoolbar":1,"skin":"monobook","stubthreshold":0,"thumbsize":2,"underline":2,"uselivepreview":0,"usenewrc":0,"watchcreations":0,"watchdefault":0,"watchdeletion":0,"watchlistdays":3,
"watchlisthideanons":0,"watchlisthidebots":0,"watchlisthideliu":0,"watchlisthideminor":0,"watchlisthideown":0,"watchlisthidepatrolled":0,"watchmoves":0,"wllimit":250,"variant":"en","language":"en","searchNs0":true,"searchNs1":false,"searchNs2":false,"searchNs3":false,"searchNs4":false,"searchNs5":false,"searchNs6":false,"searchNs7":false,"searchNs8":false,"searchNs9":false,"searchNs10":false,"searchNs11":false,"searchNs12":false,"searchNs13":false,"searchNs14":false,"searchNs15":false});;},{},{});mw.loader.implement("user.tokens",function(){mw.user.tokens.set({"editToken":"+\\","watchToken":false});;},{},{});
/* cache key: komod_wikidb:resourceloader:filter:minify-js:7:c89fc005766e312c555f83b307d08d63 */
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.page.startup","mediawiki.legacy.wikibits","mediawiki.legacy.ajax"]);
}</script>
</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Komodia_s_Redirector_COM_framework_guide skin-monobook action-edit">
<div id="globalWrapper">
<div id="column-content"><div id="content" class="mw-body-primary">
	<a id="top"></a>
	
	<h1 id="firstHeading" class="firstHeading"><span dir="auto">View source for Komodia's Redirector COM framework guide</span></h1>
	<div id="bodyContent" class="mw-body">
		<div id="siteSub">From Komodia</div>
		<div id="contentSub">← <a href="index.php/Komodia's_Redirector_COM_framework_guide.html" title="Komodia's Redirector COM framework guide">Komodia's Redirector COM framework guide</a></div>
		<div id="jump-to-nav" class="mw-jump">Jump to: <a href="index.php@title=Komodia%2527s_Redirector_COM_framework_guide&amp;action=edit.html#column-one">navigation</a>, <a href="index.php@title=Komodia%2527s_Redirector_COM_framework_guide&amp;action=edit.html#searchInput">search</a></div>
		<!-- start content -->
<div id="mw-content-text"><p>You do not have permission to edit this page, for the following reason:
</p>
<div class="permissions-errors">
<p>The action you have requested is limited to users in the group: <a href="http://www.komodia.com/wiki/index.php?title=Komodia:Users&amp;action=edit&amp;redlink=1" class="new" title="Komodia:Users (page does not exist)">Users</a>.
</p>
</div>
<hr />
<p>You can view and copy the source of this page:
</p><textarea readonly="" accesskey="," id="wpTextbox1" cols="80" rows="25" style="" lang="en" dir="ltr" name="wpTextbox1">This page covers the programming aspects of [[Komodia's Redirector]] product when using the COM interface to extend the Redirector’s functionality, this option is good for you if you don't have experience with C/C++ or want to control the product directly from your application.

There are two extra options to extend the Redirector: 

* Modify the source code directly inside the class: CClientCustomizations (it's similar to the DLL interface), you also need to uncomment this line: #define SERVICE_CUSTOM_EXTENSIONS inside KomodiaProduct.h 
* Use the [[Komodia's Redirector DLL framework guide]] to extend the Redirector via a C/C++ DLL.

= Overview =

To work with the COM interface you need implement the interface PCProxyLib.IParentalControl and tell the Redirector via the API what is your interface, once your interface is registered you will start to receive traffic and be able to control it.

= High level overview =

The COM framework allows you to receive networking events from the SDK and do processing on them, the flow is:

# Register your COM interface.
# Receive NewConnection event (called per each new connection).
# Tell the SDK if to allow/block the connection, if allow, decide which data processing you want (raw, HTTP Parser, both, none).
# Receive data via relevant methods, depending on the processing type.
# Receive ConnectionClose when the connection was closed.
# End of work, remove your COM interface.

= API =

== SetInterface ==

&lt;pre>
SetParentalInterface(IParentalControl* pInt,
		     long lNewConnectionsOnly,
		     long lDisconnectOnError);
&lt;/pre>

This function is used to tell the Redirector what is the class you are going to use:

pInt - The interface class that will receive all the data.

lNewConnectionsOnly - This will tell the Redirector if you want to receive connections that started before you sent your interface to the Redirector, sending true will mean that you will receive connections without seeing the function NewConnection first.

lDisconnectOnError - This will tell the Redirector if to stop calling the interface in case there's an error using it.

How to register the interface:

&lt;pre>
Dim dt As PCProxyLib.DataController = new PCProxyLib.DataController
dt.SetInterface(your interface class,true,true)
&lt;/pre>

== IDataContainer ==

This class is used to transfer data between the SDK to the application that uses COM, the reason this class is used is because there's a limitation on the size of a string you can transfer using COM.

=== GetSize ===

&lt;pre>
GetSize([out,retval]long* lSize);
&lt;/pre>

Get the size in bytes of the data.

=== RequestString ===

&lt;pre>
RequestString(long lPosition,
	      long lSize,
	      [out,retval]BSTR* pData);
&lt;/pre>

This functions gets the data in a string format.

==== Parameters ====

lPosition - Where to start getting the data.

lSize - Size of data to request.

pData - Data received.

If you send both lPosition and lSize as zero the function will give you the full string, unless the string size is greater then 100k, in that case it will throw an error.

=== RequestString64 ===

&lt;pre>
RequestString64(long lPosition,
	        long lSize,
	        [out,retval]BSTR* pData);
&lt;/pre>

This functions gets the data in a base64 format, this is used in case the data is binary.

==== Parameters ====

lPosition - Where to start getting the data.

lSize - Size of data to request.

pData - Data received (Data received is usually twice the size because of the base64 encodings)

If you send both lPosition and lSize as zero the function will give you the full base64 string, unless the string size is greater then 100k, in that case it will throw an error.

=== SetDataFromString ===

&lt;pre>
SetDataFromString(BSTR bData);
&lt;/pre>

This functions will change the data in the container and set it to the string you provide.

=== SetDataFromString64 ===

&lt;pre>
SetDataFromString64(BSTR bData);
&lt;/pre>

This functions will change the data in the container and set it to the data you provide using Base64.

=== ReplaceData ===

&lt;pre>
HRESULT ReplaceData(long lPosition,
                    BSTR bData);
&lt;/pre>

This function will replace a data inside the string, the function only replaces existing data, if it's in the end of the data, it will not do an insert.

==== Parameters ====

lPosition - Position to start the replace.

bData - String to replace with.

=== InjectData ===

&lt;pre>
HRESULT InjectData(long lPosition,
                   BSTR bData);
&lt;/pre>

This function will insert a data inside the string and push the existing data after the inserted string.

==== Parameters ====

lPosition - Position to start the insert.

bData - String to insert.

=== RemoveData ===

&lt;pre>
RemoveData(long lPosition,
           long lSize);
&lt;/pre>

This function will delete data from the string and move the remaining data back.

==== Parameters ====

lPosition - Position to start the delete.

lSize - Number of characters to delete.

=== SearchString ===

&lt;pre>
SearchString(BSTR bStringToSearch,
             long lIgnoreCase,
             [out,retval]long* pPosition);
&lt;/pre>

This function searches for a string inside the data.

==== Parameters ====

bStringToSearch - String to search for.

lIgnoreCase - set to 1 if you want the search to be case insensitive.

pPosition - Position of string found, -1 for not found.

=== SearchHTMLString ===

&lt;pre>
SearchHTMLString(BSTR bStringToSearch,
                 [out,retval]long* pPosition);
&lt;/pre>

This function searches for a html string inside the data (it will ignore formatting that is legal to HTML, for example if the text contains &lt; head >, searching for &lt;head> will find it as well, it is case insensitive by default.

==== Parameters ====

bStringToSearch - String to search for.

pPosition - Position of string found, -1 for not found.

=== SearchStringPosition ===

&lt;pre>
SearchStringPosition(BSTR bStringToSearch,
                     long lIgnoreCase,
                     long lStartFrom,
                     [out,retval]long* pPosition);
&lt;/pre>

This function searches for a string inside the data starting at a specific position.

==== Parameters ====

bStringToSearch - String to search for.

lIgnoreCase - set to 1 if you want the search to be case insensitive.

lStartFrom - Position to start the search from.

pPosition - Position of string found, -1 for not found.

=== SearchHTMLStringPosition ===

&lt;pre>
SearchHTMLStringPosition(BSTR bStringToSearch,
                         long lStartFrom,
                         [out,retval]long* pPosition);
&lt;/pre>

This function searches for a html string inside the data starting at a specific position (it will ignore formatting that is legal to HTML, for example if the text contains &lt; head >, searching for &lt;head> will find it as well, it is case insensitive by default).

==== Parameters ====

bStringToSearch - String to search for.

lStartFrom - Position to start the search from.

pPosition - Position of string found, -1 for not found.

=== SaveToFile===

&lt;pre>
SaveToFile(BSTR bFileName,
           long lAppend,
           long lInThread,
           [out,retval]long* pResult);
&lt;/pre>

This function saves the data into a file.

==== Parameters ====

bFileName - File name (full path required)

lAppend - 0 To overwrite the file, 1 to append to it

lInThread - 0 operation will be from current thread and execution in app will resume when file was written, 1 to execute it from a different thread, in this mode you don't have a way to know when the write have ended.

pResult - Result, 0 for failure, 1 for success.

=== SearchRegex ===

&lt;pre>
SearchRegex(BSTR bStringToSearch,
            [out,retval]long* pPosition);
&lt;/pre>

This function searches for a regex inside the data.

==== Parameters ====

bStringToSearch - Regex to search for.

pPosition - Position of string found, -1 for not found.

=== SearchRegexPosition ===

&lt;pre>
SearchRegexPosition(BSTR bStringToSearch,
                    long lStartFrom,
                    [out,retval]long* pPosition);
&lt;/pre>

This function searches for a regex inside the data starting at a specific position.

==== Parameters ====

bStringToSearch - Regex to search for.

lStartFrom - Position to start the search from.

pPosition - Position of string found, -1 for not found.

== IParentalControl ==

This is the class you need to implement, the language you use will implement the skeleton for you, you just need to embedd your code.

How to implement the class in VB.Net:

&lt;pre>
Implements PCProxyLib.IParentalControl
&lt;/pre>

=== NewConnection ===

&lt;pre>
NewConnection(long lConnectionID,
	      long lFromEncryption,
	      long lPID,
	      BSTR bProcessName,
              BSTR bUsername,
	      BSTR bDomain,
	      BSTR bIPString,
	      [in,out]long* lIP,
	      [in,out]long* lPort,
	      [in,out]long* lSSL,
	      [in,out]long* lProxyModified,
	      [in,out]IProxyType* lProxyType,
	      [in,out]long* lProxyIP,
	      [in,out]long* lProxyPort,
	      [in,out]BSTR* pUsername,
	      [in,out]BSTR* pPassword,
	      BSTR bDNSEntry,
	      [in,out]FilteringType* pFilteringType,
	      [in,out]BSTR* bStringToStore,
	      [out,retval]long* lAllow);
&lt;/pre>

This function is called whenever a new connection was made to PCProxy. 

==== Parameters ====

The parameters are: 

lConnectionID – A unique ID that will be used to identify the current socket connection, it's important to note that for HTTP connections you can have multiple requests on the same connection.

lFromEncryption – In case the data was originally encrypted with SSL but decrypted with the SSL decryptors, this flag will be true. 

lPID - Process ID of the application that created the connection.

bProcessName - Name of the application that created the connection.

bUsername - The username of the application that created the connection.

bDomain - The domain of the application that created the connection.

bIPString - The destination IP that this session is trying to connect to, this in in form of a string, for example: "127.0.0.1".

lIP – The destination IP that this session is trying to connect to. The programmer can change this value and the session will connect to the new IP. 

lPort – The destination port that this session is trying to connect to. The programmer can change this value and the session will connect to the new port.

lSSL – Outputs this stream as SSL data (you will probably also need to change the port to 443).

==== Proxy variables ====

lProxyModified - Set this flag to true in case you set or modified the proxy settings.

&lt;pre>
typedef enum _IProxyType
{
    iptHTTP,
    iptHTTPConnect,
    iptHTTPConnectSSL,
    iptHTTPHybrid,
    iptHTTPHybridSSL,
    iptSocks4,
    iptSocks5,
    iptHTTPSSL,
    iptSocks5TCPUDP,
    iptRedirect,
    iptRedirectBypass,
    iptSSLSubst,
    iptNone
} IProxyType;
&lt;/pre>


The proxy variables are in/out which means they will contain the current settings and you will be able to change them:

lProxyType - This will contain the type of proxy (if proxy is set), and you can change it. (you can see description of each proxy type here: [[Komodia's Redirector installation guide#Proxy_type]].

lProxyIP - The IP of the proxy.

lProxyPort - The port of the proxy.

pUsername - Proxy username if applicable.

pPassword - Proxy password if applicable.

==== More parameters ====

bDNSEntry - Incase you have the [[DNS Hijacker]], this will contain the DNS entry of the connection.

&lt;pre>
typedef enum _FilteringType
{
    ftNothing,
    ftNothingDisableParental,
    ftDataOnly,
    ftParentalOnly,
    ftParentalTextOnly,
    ftDataAndParental,
    ftParentalOnlyMinimal
} FilteringType;
&lt;/pre>

pFilteringType - Type of filtering you want for this connection:

* ftNothing - You don't want to receive any more data on this connection.
* ftNothingDisableParental - You don't want to receive any more data on this connection and if you have the HTTP Parser, it will disable it for this connection.
* ftDataOnly - You want to receive only the data without doing HTTP parsing.
* ftParentalOnly - You want to receive only the parsed HTTP data.
* ftParentalTextOnly - You want to receive only text based parsed HTTP data (html files).
* ftDataAndParental - You want to receive both raw data and parsed HTTP data (if possible).
* ftParentalOnlyMinimal - Same as ftParentalOnly, but will not send the raw header and full URL to conserve CPU.

bStringToStore - You can store any info you want in this string and you will receive it all across the current connection.

On Windows 8/8.1 when using a WFP, in case there's a cascading proxy redirect, there may be an option to get the original application (on top of the proxy process that was redirected), and then bStringToStore contain that process name (you can still modify the string as you would when it was empty). 

lAllow - Do you want to allow this connection or block it.

==== Samples ====

Samples are written in VB.Net

===== Redirect to a proxy =====

&lt;pre>
lProxyIP = System.Net.IPAddress.Parse("127.0.0.1").Address 'On C#: lProxyIP = (int)System.Net.IPAddress.Parse("127.0.0.1").Address;
lProxyPort = 1080
lProxyModified = 1
lProxyType = PCProxyLib._IProxyType.iptSocks5
&lt;/pre>

This will redirect the connection to a SOCKS5 proxy located at: 127.0.0.1:1080

In VB.net there may be issues with converting signed to unsigned (for the IP address), this is a code that can do the conversion:

&lt;pre>
Dim bb() As Byte = System.BitConverter.GetBytes(System.Net.IPAddress.Parse("127.0.0.1").Address)
Dim Myint = System.BitConverter.ToInt32(bb, 0)
lProxyIP=Myint
&lt;/pre>

=== DataBeforeSend ===

&lt;pre>
DataBeforeSend(long lConnectionID,
	       [in,out]IDataContainer** pData,
	       [in,out]long* lTerminateSession,
	       [in,out]long* lNewBufferToReceive,
	       [in,out]BSTR* bStringToStore,
	       [out,retval]DataActionType* pAction);
&lt;/pre>

This function is called whenever there's a new outgoing data, and you set the filtering to: ftDataOnly

==== Parameters ====

The parameters are: 

lConnectionID – A unique ID that will be used to identify the current socket connection, it's important to note that for HTTP connections you can have multiple requests on the same connection. 

pData - The outgoing data, you can also modify this data.

lTerminateSession – Set to 1 to terminate the session when this function exits (if you don't want the data to be sent, you need to clear it)

lNewBufferToReceive – Takes the contents of the new data and sends it to the application that initiated the session (used mostly for redirects). 

bStringToStore - This string is to save custom data across the connection, you can store any data you want inside.

&lt;pre>
typedef enum _DataActionType
{
    naAllowData,
    naDataChanged
} DataActionType;
&lt;/pre>

pAction - Action to perform:

* naAllowData - Data sent as it.
* naDataChanged - Indicates you have modified the data.

=== DataBeforeReceive ===

&lt;pre>
DataBeforeReceive(long lConnectionID,
	          [in,out]IDataContainer** pData,
	          [in,out]long* lTerminateSession,
	          long lServerClosed,
	          [in,out]BSTR* bStringToStore,
	          [out,retval]DataActionType* pAction);
&lt;/pre>

This function is called whenever there's a new incoming data, and you set the filtering to: ftDataOnly

==== Parameters ====

The parameters are: 

lConnectionID – A unique ID that will be used to identify the current socket connection, it's important to note that for HTTP connections you can have multiple requests on the same connection. 

pData - The outgoing data, you can also modify this data.

lTerminateSession – Set to 1 to terminate the session when this function exits (if you don't want the data to be received, you need to clear it).

lServerClosed – When this flag is set, it means that the remote server closed the connection and at this stage you have last chance to send data to the client side before the Redirector closes the connection. 

bStringToStore - This string is to save custom data across the connection, you can store any data you want inside.

&lt;pre>
typedef enum _DataActionType
{
    naAllowData,
    naDataChanged
} DataActionType;
&lt;/pre>

pAction - Action to perform:

* naAllowData - Data sent as it.
* naDataChanged - Indicates you have modified the data.

=== ConnectionClosed ===

&lt;pre>
ConnectionClosed(long lConnectionID,
		 long lError,
		 BSTR bStringToStore);
&lt;/pre>

This function is called when the connection was closed, and you set the filtering to: ftDataOnly or ftParentalOnly

==== Parameters ====

The parameters are: 

lConnectionID – A unique ID that will be used to identify the current socket connection, it's important to note that for HTTP connections you can have multiple requests on the same connection. 

lError - If the connection was closed because of an error, this will contain the Winsock error code.

bStringToStore - This string is to save custom data across the connection, you can store any data you want inside.

=== HTTP Parser ===

The following functions are part of the HTTP Parser.

==== Results enum ====

This enum is used to define behavior with the data methods.
&lt;pre>
typedef enum _ActionType
{
    atNothing=0,
    atBlock,
    atRedirect,
    atModifiedHeader,
    atModifyBody,
    atModifyBodyAndHeader,
    atHTMLInString,
    atDontDoParental,
    atDontProcessPost,
    atDontDoParentalAndDontProcessPost,
    atSkip,
    atModifyBodySDKAdjustHeader,
    atBuildButDontAggregate,
    atDefer,
    atModifyDontProcessPostPayload,
    atDontDoParentalAndDontProcessPostModify
} ActionType;
&lt;/pre>

==== NewRequest ====

&lt;pre>
NewRequest(long lConnectionID,
	   [in,out]IDataContainer** pHeader,
	   BSTR bHeaderNoPost,
	   BSTR bHost,
	   BSTR bURL,
	   BSTR bFullRequest,
	   long lPartialPost,
	   [in,out]BSTR* bRedirectTo,
	   [in,out]BSTR* bStringToStore,
	   [out,retval]ActionType* pAction);
&lt;/pre>

This function is called whenever there's a new HTTP request, and you set the filtering to: ftParentalOnly

The function can be called twice per request in case of a post, if the POST data is fragmented then the function will be called and will give your the opportunity to tell the SDK not to accumulate the POST data.

===== Parameters =====

The parameters are:

lConnectionID - A unique ID that will be used to identify the current socket connection, it's important to note that for HTTP connections you can have multiple requests on the same connection. 

pHeader - The request header data, can be modified, in case the request is post and lPartialPost==0 then the post data will come in this parameter right after the header, the post data will start right after \r\n\r\n that terminates the header.

bHeaderNoPost - Contains the header, in case of a POST, it will not contain the POST data.

bHost - Host field from the request.

bURL - URL part of the request (i.e. /somefolder/somefile.php)

bFullRequest - Full URL request (i.e. www.komodia.com/somefolder/somefile.php)

lPartialPost - If set to 1, it means this is a POST and the full data didn't arrive yet.

bRedirectTo - If you want to redirect the request to another page, set this variable to that page (i.e. http://www.google.com)

bStringToStore - This string is to save custom data across the connection, you can store any data you want inside.

pAction - Action to perform: (this tells the SDK how to process the data)

* atNothing - Do nothing, data will pass normally, in case of a POST, it will be accumulated.
* atBlock - Block this request, the data will not be send, browser will timeout or try again.
* atRedirect - Redirect the browser to the URL specified at bRedirectTo.
* atModifiedHeader - Indicate the header was modified.
* atDontDoParental - For this request, turn off the HTTP Parser, this will apply to the receive part, in case of POST, it will accumulate.
* atDontProcessPost, - For this request, turn off the HTTP Parser, this will apply to the send part only, in case of POST.
* atDontDoParentalAndDontProcessPost - Turn HTTP Parser off for both request and reply.
* atSkip - Allow the SDK to decide which action to take (the SDK will only try to accumulate minimal amount of data needed).
* atModifyDontProcessPostPayload - For this request, modify the POST header and turn off the HTTP Parser for the POST payload.
* atDontDoParentalAndDontProcessPostModify- For this request, modify the POST header and turn off the HTTP Parser for the POST payload and POST reply.

===== Samples =====

Samples are written in VB.Net

====== Redirect a site ======

Redirect the site cnn.com to google.com:

&lt;pre>
If (LCase(bFullRequest).IndexOf("cnn.com"))&lt;>-1 then
    bRedirectTo="http://www.google.com"
    NewRequest=PCProxyLib._ActionType.atRedirect
Else
    NewRequest=PCProxyLib._ActionType.atSkip
End If
&lt;/pre>

==== NewReply ====

&lt;pre>
NewReply(long lConnectionID,
	 BSTR bRequestHeader,
	 BSTR bFullRequestURL,
	 BSTR bReplyHeader,
	 BSTR bContentType,
	 long lReplyOnly,
	 [in,out]IDataContainer** pReplyHeader,
	 [in,out]IDataContainer** pReplyBody,
	 [in,out]BSTR* bRedirectTo,
	 [in,out]BSTR* bStringToStore,
	 [out,retval]ActionType* pAction);
&lt;/pre>

This function is called whenever there's a new HTTP reply, and you set the filtering to: ftParentalOnly

The function can be called twice per reply in case the data was big and didn't arrive in one chunk, if the data is fragmented then the function will be called and will give your the opportunity to tell the SDK not to accumulate the data, in case you don't need to, usually when it's a big movie or a file.

===== Parameters =====

The parameters are:

lConnectionID - A unique ID that will be used to identify the current socket connection, it's important to note that for HTTP connections you can have multiple requests on the same connection. 

bRequestHeader - Contains the request header, in case of a POST, it will not contain the POST data.

bFullRequestURL - Full URL request (i.e. www.komodia.com/somefolder/somefile.php)

bReplyHeader - Header of the reply.

bContentType - Content type of the reply.

lReplyOnly - If the data was fragmented, and this reply contains the header only, this flag is set to 1.

pReplyHeader - The reply header data, can be modified.

pReplyBody - The reply data (will be set only if lReplyOnly is zero), can be modified.

bRedirectTo - If you want to redirect the request to another page, set this variable to that page (i.e. http://www.google.com)

bStringToStore - This string is to save custom data across the connection, you can store any data you want inside.

pAction - Action to perform: (this tells the SDK how to process the data)

* atNothing - Do nothing, data will pass normally, in case of a big reply, it will be accumulated.
* atBlock - Block this request, the data will not be send, browser will timeout or try again.
* atRedirect - Redirect the browser to the URL specified at bRedirectTo.
* atModifiedHeader - Indicate that the reply header was modified.
* atModifyBody - Indicate that the reply body was modified (you are responsible to adjust the HTTP header)
* atModifyBodyAndHeader - Indicate that the reply header and body was modified.
* atHTMLInString - You want to reply with a HTML data that was stored in bRedirectTo (the SDK will build the header).
* atDontDoParental - For this reply only, turn off the HTTP Parser.
* atSkip - Allow the SDK to decide which action to take (the SDK will only try to accumulate minimal amount of data needed).
* atModifyBodySDKAdjustHeader - This tells the SDK to adjust the header size field base on a modified body you have provided.

==== HTTP 101 response code ====

You can read here: [[Komodia's Redirector DLL framework guide#HTTP 101 response code]] on how the HTTP Parser manages 101 response code.

==== How to get HTML data ====

The HTTP Parser is built so you control which data to "hold" and which not to, to allow faster load rate, the sequence described here shows how to control the retrieval of HTML data:

# NewRequest being called, indicating the browser made a web request, at this point you can either:
## Redirect it into another address using the atRedirect option.
## Modify the header using the: atModifiedHeader, atHTMLInString options.
## If you decide you don't want to inspect this request's reply, you can use: atDontDoParental, atDontDoParentalAndDontProcessPost.
## If you do want to inspect the request's reply you need to return the flag atNothing.
# NewReply being called, if the payload is big, you will only get the headers and have the flag lReplyOnly==1, at this point you can:
## Redirect it into another address using the atRedirect option.
## Modify the header and/or body using the: atModifiedHeader, atHTMLInString, atModifyBodyAndHeader options.
## If you decide you don't want to inspect this reply, you can use: atDontDoParental.
## If you do want to inspect the request's reply you need to return the flag atNothing.
# NewReply being called, with full payload, and the flag lReplyOnly==0, at this point you can:
## Redirect it into another address using the atRedirect option.
## Modify the header and/or body using the: atModifiedHeader, atHTMLInString, atModifyBodyAndHeader options.
## Let it go to the browser using thr atNothing flag.

It's possible to only receive one reply with lReplyOnly==0 in case the payload did manage to fit in a single call.

= COM errors =

The SDK will treat COM errors according to the parameter in SetInterface:

# lDisconnectOnError==0 - SDK will keep passing data to the COM interface, even if there are delays or errors on application side, if application is hanged or slowed down, this will affect network speed.
# lDisconnectOnError==1 - SDK will remove interface to application on first COM error and will not send anymore data, this is to prevent situation where the application hangs or slows down.

== Detecting COM interface removal ==

To detect the removal of your COM interface (only when lDisconnectOnError==1), you need to poll the COM method GetInstaceID, once the value is changed it means that your COM interface was removed and you need to register it again, preferably a new class.

= Interop =

The SDK itself does not need .Net to operate, but when using VB.Net or C# to use the COM framework, the compiler generates Interop file for the COM library (it's a .Net requirement), and you might want to control the version of the Interop for compatability reasons.

# Set the .Net version at your project setting.
# Some VS versions are bugged and can't create lower version Interop, then you should resort to earlier VS versions just to create the Interop (http://stackoverflow.com/questions/2659738/visual-studio-2010-tlbimp-generates-net-4-0-interops-in-2-0-projects)

= Common pitfalls =

== Multi threading ==

The callbacks calls are multi threaded, make sure that non thread safe code is protected with Mutex or Critical section.

== Not understanding what lReplyOnlydoes ==

lReplyOnly is the core of the HTTP reply processing, not using it will often lead to problems of not seeing HTTP responses.

== Modifying HTTP body size ==

When modifying the HTTP body size, it must be reflected in the header, this can be done by either using a flag that tells the SDK to adjust the header automatically (atModifyBodySDKAdjustHeader), or modify the header in the DLL and use a flag that indicates that the header has been modified (atModify).

== Spending too much time inside callbacks ==

The COM callbacks should not spend more then five seconds inside a callback, more then that can cause unexpected behavior (the true safe limit is 20 seconds, after 5 seconds inside a callback warnings will be written to the log)

== COM client failing or errors ==

Incase of an error or freeze in the client, all traffic will be blocked, the solution can be to set the interface with lDisconnectOnError==1, this will mean that when the COM client freezes/errors out, the SDK removes the interface and the client will need to re register itself to get data.
</textarea><div class="templatesUsed"></div><p id="mw-returnto">Return to <a href="index.php/Komodia's_Redirector_COM_framework_guide.html" title="Komodia's Redirector COM framework guide">Komodia's Redirector COM framework guide</a>.</p>
</div><div class="printfooter">
Retrieved from "<a href="index.php/Komodia's_Redirector_COM_framework_guide.html">http://www.komodia.com/wiki/index.php/Komodia%27s_Redirector_COM_framework_guide</a>"</div>
		<div id='catlinks' class='catlinks catlinks-allhidden'></div>		<!-- end content -->
				<div class="visualClear"></div>
	</div>
</div></div>
<div id="column-one">
	<div id="p-cactions" class="portlet">
		<h5>Views</h5>
		<div class="pBody">
			<ul>
				<li id="ca-nstab-main" class="selected"><a href="index.php/Komodia's_Redirector_COM_framework_guide.html" primary="1" context="subject" title="View the content page [c]" accesskey="c">Page</a></li>
				<li id="ca-talk" class="new"><a href="http://www.komodia.com/wiki/index.php?title=Talk:Komodia%27s_Redirector_COM_framework_guide&amp;action=edit&amp;redlink=1" primary="1" context="talk" title="Discussion about the content page [t]" accesskey="t">Discussion</a></li>
				<li id="ca-viewsource" class="selected"><a href="index.php@title=Komodia%2527s_Redirector_COM_framework_guide&amp;action=edit.html" primary="1" title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></li>
				<li id="ca-history"><a href="index.php@title=Komodia%2527s_Redirector_COM_framework_guide&amp;action=history.html" rel="archives" title="Past revisions of this page [h]" accesskey="h">History</a></li>
			</ul>
		</div>
	</div>
	<div class="portlet" id="p-personal">
		<h5>Personal tools</h5>
		<div class="pBody">
			<ul>
				<li id="pt-anonuserpage"><a href="http://www.komodia.com/wiki/index.php/User:46.165.222.245" class="new" title="The user page for the IP address you are editing as [.]" accesskey=".">46.165.222.245</a></li>
				<li id="pt-anontalk"><a href="http://www.komodia.com/wiki/index.php/User_talk:46.165.222.245" class="new" title="Discussion about edits from this IP address [n]" accesskey="n">Talk for this IP address</a></li>
				<li id="pt-anonlogin"><a href="index.php@title=Special%253AUserLogin&amp;returnto=Komodia%2527s+Redirector+COM+framework+guide&amp;returntoquery=action%253Dedit.html" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Log in</a></li>
			</ul>
		</div>
	</div>
	<div class="portlet" id="p-logo">
<a href="index.php/Main_Page.html" style="background-image: url(http://www.komodia.com/images/logo.png);" title="Visit the main page"></a>
	</div>
	<div class="generated-sidebar portlet" id="p-navigation">
		<h5>Navigation</h5>
		<div class='pBody'>
			<ul>
				<li id="n-mainpage-description"><a href="index.php/Main_Page.html" title="Visit the main page [z]" accesskey="z">Main page</a></li>
				<li id="n-Official-homepage"><a href="../index.php.html">Official homepage</a></li>
				<li id="n-recentchanges"><a href="index.php/Special%253ARecentChanges.html" title="A list of recent changes in the wiki [r]" accesskey="r">Recent changes</a></li>
			</ul>
		</div>
	</div>
	<div id="p-search" class="portlet">
		<h5><label for="searchInput">Search</label></h5>
		<div id="searchBody" class="pBody">
			<form action="http://www.komodia.com/wiki/index.php" id="searchform">
				<input type='hidden' name="title" value="Special:Search"/>
				<input type="search" name="search" title="Search Komodia [f]" accesskey="f" id="searchInput" />
				<input type="submit" name="go" value="Go" title="Go to a page with this exact name if exists" id="searchGoButton" class="searchButton" />&#160;
				<input type="submit" name="fulltext" value="Search" title="Search the pages for this text" id="mw-searchButton" class="searchButton" />
			</form>
		</div>
	</div>
	<div class="portlet" id="p-tb">
		<h5>Toolbox</h5>
		<div class="pBody">
			<ul>
				<li id="t-whatlinkshere"><a href="index.php/Special%253AWhatLinksHere/Komodia's_Redirector_COM_framework_guide.html" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li>
				<li id="t-recentchangeslinked"><a href="index.php/Special%253ARecentChangesLinked/Komodia's_Redirector_COM_framework_guide.html" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li>
				<li id="t-specialpages"><a href="index.php/Special%253ASpecialPages.html" title="A list of all special pages [q]" accesskey="q">Special pages</a></li>
			</ul>
		</div>
	</div>
</div><!-- end of the left (by default at least) column -->
<div class="visualClear"></div>
<div id="footer">
	<div id="f-poweredbyico">
		<a href="http://www.mediawiki.org/"><img src="skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" width="88" height="31" /></a>
	</div>
	<ul id="f-list">
		<li id="privacy"><a href="index.php/Komodia%253APrivacy_policy.html" title="Komodia:Privacy policy">Privacy policy</a></li>
		<li id="about"><a href="index.php/Komodia%253AAbout.html" title="Komodia:About">About Komodia</a></li>
		<li id="disclaimer"><a href="index.php/Komodia%253AGeneral_disclaimer.html" title="Komodia:General disclaimer">Disclaimers</a></li>
	</ul>
</div>
</div>
<script>if(window.mw){
mw.loader.state({"site":"loading","user":"missing","user.groups":"ready"});
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.user","mediawiki.page.ready","mediawiki.searchSuggest"], null, true);
}</script>
<script>if(window.mw){
mw.loader.state({"site":"ready"});
}</script>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
var pageTracker = _gat._getTracker("UA-6898822-1");
pageTracker._trackPageview();
</script><!-- Piwik -->
<script type="text/javascript">
/* <![CDATA[ */
var pkBaseURL = (("https:" == document.location.protocol) ? "https://piwik.komodia.com/" : "http://piwik.komodia.com/");
document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
/* ]]> */
</script>
<script type="text/javascript">
/* <![CDATA[ */
try {
var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 6);
piwikTracker.setDocumentTitle("");
piwikTracker.setIgnoreClasses("image");

piwikTracker.trackPageView();
piwikTracker.enableLinkTracking();
} catch( err ) {}
/* ]]> */
</script><noscript><p><img src="http://piwik.komodia.com/piwik.php?idsite=6" style="border:0" alt=""/></p></noscript>
<!-- /Piwik --><!-- Served in 0.189 secs. --></body></html>